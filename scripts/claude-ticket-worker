#!/bin/bash
# claude-ticket-worker CSLOG-16
# Launches interactive Claude Code session with ticket context
# User can type /complete <summary> to signal completion

set -e

TICKET_ID=$1
REPO_PATH="/home/cslog/ai-workflow"

if [[ -z "$TICKET_ID" ]]; then
  echo "Error: Ticket ID required"
  echo "Usage: claude-ticket-worker CSLOG-16"
  exit 1
fi

cd "$REPO_PATH" || exit 1

# Extract project identifier and issue number
# CSLOG-16 -> project=CSLOG, issue=16
PROJECT_ID="${TICKET_ID%%-*}"
ISSUE_NUM="${TICKET_ID##*-}"

echo "==== ğŸ« Working on $TICKET_ID ===="
echo ""

# Fetch ticket details via Plane MCP
echo "ğŸ“¡ Fetching ticket details from Plane..."
TICKET_DATA=$(claude mcp call plane get_issue_using_readable_identifier \
  --project_identifier "$PROJECT_ID" \
  --issue_identifier "$ISSUE_NUM" 2>/dev/null || echo "{}")

if [[ "$TICKET_DATA" == "{}" ]] || [[ -z "$TICKET_DATA" ]]; then
  echo "âš ï¸  Warning: Could not fetch ticket details from Plane"
  echo "Continuing with ticket ID only..."
  TICKET_TITLE="$TICKET_ID"
  TICKET_DESC=""
else
  TICKET_TITLE=$(echo "$TICKET_DATA" | jq -r '.name // "Unknown"' 2>/dev/null || echo "$TICKET_ID")
  TICKET_DESC=$(echo "$TICKET_DATA" | jq -r '.description_text // ""' 2>/dev/null || echo "")

  echo "ğŸ“‹ Title: $TICKET_TITLE"
  if [[ -n "$TICKET_DESC" ]]; then
    echo "ğŸ“ Description:"
    echo "$TICKET_DESC" | head -10
    echo ""
  fi
fi

echo "=============================="
echo ""
echo "ğŸ¤– Starting Claude Code session..."
echo "ğŸ’¬ Copy/paste this to start working on the ticket:"
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "I'm working on Plane ticket $TICKET_ID: $TICKET_TITLE"
if [[ -n "$TICKET_DESC" ]]; then
  echo ""
  echo "Description:"
  echo "$TICKET_DESC" | head -5
fi
echo ""
echo "Please help me:"
echo "1. Understand the issue by exploring the codebase"
echo "2. Propose a solution"
echo "3. Implement the fix with my guidance"
echo ""
echo "When done, type: /complete <summary of changes>"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Launch Claude Code in interactive mode
# User will paste the ticket context above to start
exec claude code
