#!/bin/bash
# ws - Quick workspace session manager with multi-host support
# Usage: ws [command] [host:]workspace-id
#   ws                    - List workspaces grouped by host
#   ws <id>               - Attach or create local workspace session
#   ws <host>:<id>        - Attach or create remote workspace session
#   ws new <id>           - Force create new local session
#   ws new <host>:<id>    - Force create new remote session
#   ws kill <id>          - Kill a local session
#   ws kill <host>:<id>   - Kill a remote session
#   ws list               - List all tmux sessions (local)
#   ws list <host>        - List all tmux sessions on remote host
#   ws add                - Launch GUI to add workspace
#   ws hosts              - List configured hosts

CONFIG_FILE="$HOME/ai-workflow/workspace-switcher/workspaces.json"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
GRAY='\033[0;90m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Parse host:workspace syntax
parse_target() {
    local target="$1"
    if [[ "$target" == *":"* ]]; then
        HOST_ID="${target%%:*}"
        WS_ID="${target#*:}"
    else
        HOST_ID="local"
        WS_ID="$target"
    fi
}

# Get SSH target for a host ID
get_ssh_target() {
    local host_id="$1"
    if [[ "$host_id" == "local" ]]; then
        echo ""
        return
    fi
    if command -v jq &> /dev/null; then
        jq -r --arg id "$host_id" '.hosts[] | select(.id == $id) | .ssh // empty' "$CONFIG_FILE" 2>/dev/null
    fi
}

# Get host name for display
get_host_name() {
    local host_id="$1"
    if command -v jq &> /dev/null; then
        jq -r --arg id "$host_id" '.hosts[] | select(.id == $id) | .name // $id' "$CONFIG_FILE" 2>/dev/null
    else
        echo "$host_id"
    fi
}

list_hosts() {
    echo -e "${BLUE}${BOLD}Configured Hosts:${NC}"
    echo ""
    if command -v jq &> /dev/null; then
        jq -r '.hosts[] | "\(.id)|\(.name)|\(.ssh // "local")"' "$CONFIG_FILE" 2>/dev/null | while IFS='|' read -r id name ssh; do
            if [[ "$ssh" == "local" ]] || [[ -z "$ssh" ]]; then
                echo -e "  ${GREEN}●${NC} ${BOLD}$name${NC} ($id) - local"
            else
                # Check if reachable
                if ssh -o ConnectTimeout=2 -o BatchMode=yes "$ssh" exit 2>/dev/null; then
                    echo -e "  ${GREEN}●${NC} ${BOLD}$name${NC} ($id) - $ssh"
                else
                    echo -e "  ${RED}●${NC} ${BOLD}$name${NC} ($id) - $ssh ${RED}(unreachable)${NC}"
                fi
            fi
        done
    else
        echo "  (install jq for host listing)"
    fi
    echo ""
}

list_workspaces() {
    echo -e "${BLUE}${BOLD}Workspaces:${NC}"
    echo ""

    if ! command -v jq &> /dev/null; then
        echo "  (install jq for better output)"
        cat "$CONFIG_FILE"
        return
    fi

    # Get list of hosts
    local hosts=$(jq -r '.hosts[].id' "$CONFIG_FILE" 2>/dev/null)

    for host_id in $hosts; do
        local host_name=$(get_host_name "$host_id")
        local ssh_target=$(get_ssh_target "$host_id")

        # Get active sessions for this host
        local active_sessions=""
        if [[ -z "$ssh_target" ]]; then
            active_sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null || echo "")
        else
            active_sessions=$(ssh -o ConnectTimeout=2 -o BatchMode=yes "$ssh_target" 'tmux list-sessions -F "#{session_name}"' 2>/dev/null || echo "")
        fi

        # Count workspaces for this host
        local ws_count=$(jq -r --arg host "$host_id" '[.workspaces[] | select(.host == $host or ($host == "local" and .host == null))] | length' "$CONFIG_FILE" 2>/dev/null)

        if [[ "$ws_count" -eq 0 ]]; then
            continue
        fi

        # Print host header
        if [[ -z "$ssh_target" ]]; then
            echo -e "  ${BOLD}[$host_name]${NC}"
        else
            if ssh -o ConnectTimeout=1 -o BatchMode=yes "$ssh_target" exit 2>/dev/null; then
                echo -e "  ${GREEN}●${NC} ${BOLD}[$host_name]${NC} ${GRAY}($ssh_target)${NC}"
            else
                echo -e "  ${RED}●${NC} ${BOLD}[$host_name]${NC} ${GRAY}($ssh_target)${NC} ${RED}unreachable${NC}"
                continue
            fi
        fi

        # List workspaces for this host
        jq -r --arg host "$host_id" '.workspaces[] | select(.host == $host or ($host == "local" and .host == null)) | "\(.id)|\(.name)|\(.path)"' "$CONFIG_FILE" 2>/dev/null | while IFS='|' read -r id name path; do
            if echo "$active_sessions" | grep -q "^${id}$"; then
                local windows=""
                if [[ -z "$ssh_target" ]]; then
                    windows=$(tmux list-windows -t "$id" 2>/dev/null | wc -l)
                else
                    windows=$(ssh -o ConnectTimeout=2 -o BatchMode=yes "$ssh_target" "tmux list-windows -t '$id'" 2>/dev/null | wc -l)
                fi
                echo -e "    ${GREEN}●${NC} ${name} (${id}) - ${windows} window(s)"
            else
                echo -e "    ${GRAY}○${NC} ${name} (${id})"
            fi
            echo -e "      ${GRAY}$path${NC}"
        done
        echo ""
    done
}

attach_workspace() {
    local target="$1"
    parse_target "$target"

    local ssh_target=$(get_ssh_target "$HOST_ID")

    # Get workspace path from config
    local ws_path
    if command -v jq &> /dev/null; then
        ws_path=$(jq -r --arg id "$WS_ID" '.workspaces[] | select(.id == $id) | .path' "$CONFIG_FILE" 2>/dev/null)
    fi

    if [ -z "$ws_path" ]; then
        ws_path="$HOME"
    fi

    if [[ -z "$ssh_target" ]]; then
        # Local session
        if tmux has-session -t "$WS_ID" 2>/dev/null; then
            echo -e "${GREEN}Attaching to local session: $WS_ID${NC}"
            tmux attach-session -t "$WS_ID"
        else
            echo -e "${YELLOW}Creating new local session: $WS_ID in $ws_path${NC}"
            tmux new-session -s "$WS_ID" -c "$ws_path"
        fi
    else
        # Remote session via SSH
        echo -e "${GREEN}Connecting to remote session: $WS_ID on $ssh_target${NC}"
        ssh -t "$ssh_target" "tmux attach -t '$WS_ID' || tmux new -s '$WS_ID' -c '$ws_path'"
    fi
}

kill_workspace() {
    local target="$1"
    parse_target "$target"

    local ssh_target=$(get_ssh_target "$HOST_ID")

    if [[ -z "$ssh_target" ]]; then
        # Local session
        if tmux has-session -t "$WS_ID" 2>/dev/null; then
            echo -e "${YELLOW}Killing local session: $WS_ID${NC}"
            tmux kill-session -t "$WS_ID"
        else
            echo "Session not found: $WS_ID"
        fi
    else
        # Remote session
        if ssh -o ConnectTimeout=2 -o BatchMode=yes "$ssh_target" "tmux has-session -t '$WS_ID'" 2>/dev/null; then
            echo -e "${YELLOW}Killing remote session: $WS_ID on $ssh_target${NC}"
            ssh "$ssh_target" "tmux kill-session -t '$WS_ID'"
        else
            echo "Remote session not found: $WS_ID on $ssh_target"
        fi
    fi
}

new_workspace() {
    local target="$1"
    parse_target "$target"

    local ssh_target=$(get_ssh_target "$HOST_ID")

    # Get workspace path
    local ws_path
    if command -v jq &> /dev/null; then
        ws_path=$(jq -r --arg id "$WS_ID" '.workspaces[] | select(.id == $id) | .path' "$CONFIG_FILE" 2>/dev/null)
    fi

    if [ -z "$ws_path" ]; then
        ws_path="$HOME"
    fi

    if [[ -z "$ssh_target" ]]; then
        # Local session
        tmux kill-session -t "$WS_ID" 2>/dev/null
        echo -e "${YELLOW}Creating fresh local session: $WS_ID${NC}"
        tmux new-session -s "$WS_ID" -c "$ws_path"
    else
        # Remote session
        ssh "$ssh_target" "tmux kill-session -t '$WS_ID'" 2>/dev/null
        echo -e "${YELLOW}Creating fresh remote session: $WS_ID on $ssh_target${NC}"
        ssh -t "$ssh_target" "tmux new -s '$WS_ID' -c '$ws_path'"
    fi
}

list_sessions() {
    local host_id="${1:-local}"

    if [[ "$host_id" == "local" ]]; then
        echo -e "${BLUE}Local tmux sessions:${NC}"
        tmux list-sessions 2>/dev/null || echo "  No sessions"
    else
        local ssh_target=$(get_ssh_target "$host_id")
        if [[ -z "$ssh_target" ]]; then
            echo "Unknown host: $host_id"
            return 1
        fi
        echo -e "${BLUE}Remote tmux sessions on $ssh_target:${NC}"
        ssh -o ConnectTimeout=3 -o BatchMode=yes "$ssh_target" 'tmux list-sessions' 2>/dev/null || echo "  No sessions or unreachable"
    fi
}

case "$1" in
    ""|"help"|"-h"|"--help")
        list_workspaces
        echo "Commands:"
        echo "  ws <id>             Attach or create local workspace"
        echo "  ws <host>:<id>      Attach or create remote workspace"
        echo "  ws new <id>         Force new local session"
        echo "  ws new <host>:<id>  Force new remote session"
        echo "  ws kill <id>        Kill local session"
        echo "  ws kill <host>:<id> Kill remote session"
        echo "  ws list [host]      List tmux sessions"
        echo "  ws hosts            List configured hosts"
        echo "  ws add              Open GUI to add workspace"
        ;;
    "hosts")
        list_hosts
        ;;
    "list")
        list_sessions "$2"
        ;;
    "add")
        python3 ~/ai-workflow/workspace-switcher/workspace-panel.py &
        ;;
    "kill")
        if [ -n "$2" ]; then
            kill_workspace "$2"
        else
            echo "Usage: ws kill [host:]<workspace-id>"
        fi
        ;;
    "new")
        if [ -n "$2" ]; then
            new_workspace "$2"
        else
            echo "Usage: ws new [host:]<workspace-id>"
        fi
        ;;
    *)
        attach_workspace "$1"
        ;;
esac
